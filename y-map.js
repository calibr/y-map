/**
 * y-map - Map Type for Yjs
 * @version v11.0.0-0
 * @license MIT
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.yMap=t()}(this,function(){"use strict";function e(e){var r=function(r){function s(n,o,r,u){t(this,s);var l=i(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return l._model=o.id,l._parent=null,l._deepEventHandler=new e.utils.EventListenerHandler,l.os=n,l.map=e.utils.copyObject(o.map),l.contents=r,l.opContents=u,l.eventHandler=new e.utils.EventHandler(function(t){var n,o="Delete"===t.struct?t.key:t.parentSub;if(n=null!=l.opContents[o]?l.os.getType(l.opContents[o]):l.contents[o],"Insert"===t.struct){if(null===t.left&&!e.utils.compareIds(t.id,l.map[o])){var i;null!=t.opContent?(i=l.os.getType(t.opContent),i._parent=l._model,delete l.contents[o],t.deleted?delete l.opContents[o]:l.opContents[o]=t.opContent):(i=t.content[0],delete l.opContents[o],t.deleted?delete l.contents[o]:l.contents[o]=t.content[0]),l.map[o]=t.id,void 0===n?e.utils.bubbleEvent(l,{name:o,object:l,type:"add",value:i}):e.utils.bubbleEvent(l,{name:o,object:l,oldValue:n,type:"update",value:i})}}else{if("Delete"!==t.struct)throw new Error("Unexpected Operation!");e.utils.compareIds(l.map[o],t.target)&&(delete l.opContents[o],delete l.contents[o],e.utils.bubbleEvent(l,{name:o,object:l,oldValue:n,type:"delete"}))}}),l}return o(s,r),n(s,[{key:"_getPathToChild",value:function(t){var n=this;return Object.keys(this.opContents).find(function(o){return e.utils.compareIds(n.opContents[o],t)})}},{key:"_destroy",value:function(){this.eventHandler.destroy(),this.eventHandler=null,this.contents=null,this.opContents=null,this._model=null,this._parent=null,this.os=null,this.map=null}},{key:"get",value:function(e){if(null==e||"string"!=typeof e)throw new Error("You must specify a key (as string)!");return null==this.opContents[e]?this.contents[e]:this.os.getType(this.opContents[e])}},{key:"keys",value:function(){return Object.keys(this.contents).concat(Object.keys(this.opContents))}},{key:"keysPrimitives",value:function(){return Object.keys(this.contents)}},{key:"keysTypes",value:function(){return Object.keys(this.opContents)}},{key:"getPrimitive",value:function(t){if(null==t)return e.utils.copyObject(this.contents);if("string"!=typeof t)throw new Error("Key is expected to be a string!");return this.contents[t]}},{key:"getType",value:function(e){if(null==e||"string"!=typeof e)throw new Error("You must specify a key (as string)!");return null!=this.opContents[e]?this.os.getType(this.opContents[e]):null}},{key:"delete",value:function(t){var n=this.map[t];if(null!=n){var o={target:n,struct:"Delete"},i=this.eventHandler,r=e.utils.copyObject(o);r.key=t,this.os.requestTransaction(function(){i.awaitOps(this,this.applyCreatedOperations,[[o]])}),i.awaitAndPrematurelyCall([r])}}},{key:"set",value:function(t,n){var o=this.map[t]||null,i={id:this.os.getNextOpId(1),left:null,right:o,origin:null,parent:this._model,parentSub:t,struct:"Insert"},r=this.eventHandler,s=e.utils.isTypeDefinition(n);if(!1!==s){var u=this.os.createType(s);return i.opContent=u._model,this.os.requestTransaction(function(){r.awaitOps(this,this.applyCreatedOperations,[[i]])}),r.awaitAndPrematurelyCall([i]),u}return i.content=[n],this.os.requestTransaction(function(){r.awaitOps(this,this.applyCreatedOperations,[[i]])}),r.awaitAndPrematurelyCall([i]),n}},{key:"observe",value:function(e){this.eventHandler.addEventListener(e)}},{key:"observeDeep",value:function(e){this._deepEventHandler.addEventListener(e)}},{key:"unobserve",value:function(e){this.eventHandler.removeEventListener(e)}},{key:"unobserveDeep",value:function(e){this._deepEventHandler.removeEventListener(e)}},{key:"observePath",value:function(t,n){function o(e){e.name===i&&n(r.get(i))}var i,r=this;if(t.length<1)return n(this),function(){};if(1===t.length)return i=t[0],n(r.get(i)),this.observe(o),function(){r.unobserve(n)};var u,l=function(){var o=r.get(t[0]);o instanceof s||(o=r.set(t[0],e.Map)),u=o.observePath(t.slice(1),n)},a=function(e){e.name===t[0]&&(null!=u&&u(),"add"!==e.type&&"update"!==e.type||l())};return r.observe(a),l(),function(){null!=u&&u(),r.unobserve(a)}}},{key:"_changed",value:function(e,t){if("Delete"===t.struct){if(null==t.key){var n=e.getOperation(t.target);t.key=n.parentSub}}else null!=t.opContent&&e.store.initType.call(e,t.opContent);this.eventHandler.receivedOp(t)}}]),s}(e.utils.CustomType);e.extend("Map",new e.utils.CustomTypeDefinition({name:"Map",class:r,struct:"Map",initType:function(e,t){var n={},o={},i=t.map;for(var s in i){var u=this.getOperation(i[s]);if(!u.deleted)if(null!=u.opContent){o[s]=u.opContent;var l=this.store.initType.call(this,u.opContent);l._parent=t.id}else n[s]=u.content[0]}return new r(e,t,n,o)},createType:function(e,t){return new r(e,t,{},{})}}))}var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},n=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),o=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};return"undefined"!=typeof Y&&e(Y),e});
//# sourceMappingURL=y-map.js.map
